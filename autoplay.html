<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‡ªå‹•ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ - TTSä»˜ã</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="css/slide.css?v=10">
  <link rel="stylesheet" href="css/themes/panhouse.css">
  <link rel="stylesheet" href="css/themes/consulting.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #0a0a0a;
      overflow: hidden;
      font-family: 'Noto Sans JP', sans-serif;
    }

    .autoplay-container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ã‚¹ãƒ©ã‚¤ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ */
    .slide-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      background: #000;
    }

    .slide-wrapper {
      position: relative;
    }

    .slide-wrapper .slide {
      width: 960px !important;
      height: 540px !important;
      transform-origin: center center;
    }

    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
    .control-bar {
      background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.9) 100%);
      padding: 20px 40px;
      display: flex;
      align-items: center;
      gap: 20px;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      opacity: 0;
      transition: opacity 0.3s;
    }

    body:hover .control-bar {
      opacity: 1;
    }

    .control-bar.always-visible {
      opacity: 1;
    }

    /* ãƒœã‚¿ãƒ³å…±é€š */
    .control-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .control-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    .control-btn.primary {
      background: #FF6B35;
      border-color: #FF6B35;
    }

    .control-btn.primary:hover {
      background: #e55a2b;
    }

    .control-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
    .progress-container {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .progress-bar {
      flex: 1;
      height: 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
      overflow: hidden;
      cursor: pointer;
    }

    .progress-fill {
      height: 100%;
      background: #FF6B35;
      transition: width 0.3s;
    }

    .slide-counter {
      color: #fff;
      font-size: 14px;
      min-width: 60px;
      text-align: center;
    }

    /* ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒˆè¡¨ç¤ºï¼ˆç”»é¢ä¸‹éƒ¨ï¼‰ */
    .speaker-notes-panel {
      position: fixed;
      bottom: 100px;  /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ä¸Š */
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      width: 80%;
      max-width: 900px;
      max-height: 120px;
      background: rgba(0,0,0,0.9);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      padding: 16px 24px;
      color: #fff;
      font-size: 15px;
      line-height: 1.7;
      overflow-y: auto;
      opacity: 0;
      transition: all 0.3s;
      z-index: 100;
    }

    .speaker-notes-panel.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .speaker-notes-panel h4 {
      font-size: 11px;
      color: #888;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* èª­ã¿ä¸Šã’ä¸­ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
    .speaking-indicator {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(255,107,53,0.9);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .speaking-indicator.active {
      opacity: 1;
    }

    .speaking-indicator .wave {
      display: flex;
      gap: 2px;
    }

    .speaking-indicator .wave span {
      display: block;
      width: 3px;
      height: 12px;
      background: #fff;
      border-radius: 2px;
      animation: wave 0.8s ease-in-out infinite;
    }

    .speaking-indicator .wave span:nth-child(2) { animation-delay: 0.1s; }
    .speaking-indicator .wave span:nth-child(3) { animation-delay: 0.2s; }
    .speaking-indicator .wave span:nth-child(4) { animation-delay: 0.3s; }

    @keyframes wave {
      0%, 100% { transform: scaleY(0.5); }
      50% { transform: scaleY(1); }
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #0a0a0a;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .loading-screen.hidden {
      display: none;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255,107,53,0.3);
      border-top-color: #FF6B35;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: #888;
      margin-top: 20px;
      font-size: 16px;
    }

    /* é–‹å§‹å‰ã®ç”»é¢ */
    .start-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .start-screen.hidden {
      display: none;
    }

    .start-screen h1 {
      color: #fff;
      font-size: 32px;
      margin-bottom: 16px;
    }

    .start-screen p {
      color: #888;
      font-size: 16px;
      margin-bottom: 32px;
    }

    .start-screen .slide-count {
      color: #FF6B35;
      font-size: 14px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <div class="loading-text">ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <!-- é–‹å§‹å‰ç”»é¢ -->
  <div class="start-screen hidden" id="startScreen">
    <div class="slide-count" id="slideCountInfo">å…¨12æšã®ã‚¹ãƒ©ã‚¤ãƒ‰</div>
    <h1 id="presentationTitle">ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</h1>
    <p>éŸ³å£°ä»˜ãã§è‡ªå‹•å†ç”Ÿã—ã¾ã™</p>
    <button class="control-btn primary" onclick="startPresentation()" style="font-size: 18px; padding: 16px 48px;">
      â–¶ å†ç”Ÿé–‹å§‹
    </button>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div class="autoplay-container">
    <div class="slide-area">
      <div class="slide-wrapper" id="slideWrapper"></div>
    </div>
  </div>

  <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ -->
  <div class="control-bar always-visible" id="controlBar">
    <button class="control-btn" id="prevBtn" onclick="prevSlide()">â—€ å‰ã¸</button>
    <button class="control-btn primary" id="playPauseBtn" onclick="togglePlayPause()">â–¶ å†ç”Ÿ</button>
    <button class="control-btn" id="nextBtn" onclick="nextSlide()">æ¬¡ã¸ â–¶</button>

    <div class="progress-container">
      <div class="progress-bar" id="progressBar" onclick="seekSlide(event)">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="slide-counter" id="slideCounter">1 / 1</div>
    </div>

    <button class="control-btn" onclick="toggleNotes()">ğŸ“ ãƒãƒ¼ãƒˆ</button>
    <button class="control-btn" onclick="toggleFullscreen()">â›¶ å…¨ç”»é¢</button>
  </div>

  <!-- èª­ã¿ä¸Šã’ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
  <div class="speaking-indicator" id="speakingIndicator">
    <div class="wave">
      <span></span><span></span><span></span><span></span>
    </div>
    èª­ã¿ä¸Šã’ä¸­...
  </div>

  <!-- ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒˆãƒ‘ãƒãƒ« -->
  <div class="speaker-notes-panel" id="notesPanel">
    <h4>ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒˆ</h4>
    <div id="notesContent"></div>
  </div>


  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Renderers -->
  <script src="js/renderer/types/BaseRenderer.js?v=10"></script>
  <script src="js/renderer/types/TitleRenderer.js?v=10"></script>
  <script src="js/renderer/types/ContentRenderer.js?v=10"></script>
  <script src="js/renderer/types/IconCardsRenderer.js?v=10"></script>
  <script src="js/renderer/types/CompareRenderer.js?v=10"></script>
  <script src="js/renderer/types/ProcessRenderer.js?v=10"></script>
  <script src="js/renderer/types/KpiRenderer.js?v=10"></script>
  <script src="js/renderer/types/TableRenderer.js?v=10"></script>
  <script src="js/renderer/types/TimelineRenderer.js?v=10"></script>
  <script src="js/renderer/types/QuoteRenderer.js?v=10"></script>
  <script src="js/renderer/types/ImageRenderer.js?v=10"></script>
  <script src="js/renderer/types/TextRenderer.js?v=10"></script>
  <script src="js/renderer/types/CardsRenderer.js?v=10"></script>
  <script src="js/renderer/types/MatrixRenderer.js?v=10"></script>
  <script src="js/renderer/types/RoadmapRenderer.js?v=10"></script>
  <script src="js/renderer/SlideRenderer.js?v=10"></script>
  <script src="js/core/JsonParser.js?v=10"></script>

  <script>
    // çŠ¶æ…‹ç®¡ç†
    let slideData = null;
    let currentSlide = 0;
    let isPlaying = false;
    let showNotes = true;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒãƒ¼ãƒˆè¡¨ç¤º

    // TTSè¨­å®š
    const ttsSettings = {
      voice: 'nova',  // OpenAI TTS voice: alloy, echo, fable, onyx, nova, shimmer
      speed: 1.3      // 0.25ã€œ4.0ï¼ˆ1.3 = è‡ªç„¶ã§èãã‚„ã™ã„é€Ÿåº¦ï¼‰
    };

    // TTS API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆRailwayä¸Šã®ãƒ—ãƒ­ã‚­ã‚·ï¼‰
    const TTS_API_URL = 'https://tldv-auto-proposal-production.up.railway.app/api/tts';

    // TTSé–¢é€£
    let audioElement = null;
    let isAudioPlaying = false;

    // éŸ³å£°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå…ˆèª­ã¿ç”¨ï¼‰
    // Map<slideIndex, { audioUrl: string, blob: Blob }>
    const audioCache = new Map();
    let prefetchAbortController = null;

    // åˆæœŸåŒ–
    async function init() {
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰IDã‚’å–å¾—
      const params = new URLSearchParams(window.location.search);
      const slideId = params.get('id');
      const dataParam = params.get('data');

      if (dataParam) {
        // data ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰JSONã‚’èª­ã¿è¾¼ã¿
        try {
          slideData = JSON.parse(decodeURIComponent(dataParam));
          showStartScreen();
        } catch (e) {
          showError('ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } else if (slideId) {
        // Supabaseã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å–å¾—
        await loadSlideFromSupabase(slideId);
      } else {
        showError('ã‚¹ãƒ©ã‚¤ãƒ‰IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      }

      // åˆæœŸçŠ¶æ…‹ã§ãƒãƒ¼ãƒˆãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
      document.getElementById('notesPanel').classList.add('visible');
    }

    async function loadSlideFromSupabase(slideId) {
      try {
        const SUPABASE_URL = 'https://fwykesvqriophaagunki.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3eWtlc3ZxcmlvcGhhYWd1bmtpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MzcyNzgsImV4cCI6MjA4MDQxMzI3OH0.8gPGdAJ2b-hfqgtB_Cc_POWZ9vNs6X0lvST57-fDq9o';

        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/slides?id=eq.${slideId}&select=*`,
          {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            }
          }
        );

        const data = await response.json();
        if (data.length === 0) {
          showError('ã‚¹ãƒ©ã‚¤ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        slideData = typeof data[0].slide_json === 'string'
          ? JSON.parse(data[0].slide_json)
          : data[0].slide_json;

        showStartScreen();
      } catch (e) {
        console.error('Error loading slide:', e);
        showError('ã‚¹ãƒ©ã‚¤ãƒ‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    function showStartScreen() {
      document.getElementById('loadingScreen').classList.add('hidden');
      document.getElementById('startScreen').classList.remove('hidden');

      const title = slideData.settings?.title || 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³';
      const slideCount = slideData.slides?.length || 0;

      document.getElementById('presentationTitle').textContent = title;
      document.getElementById('slideCountInfo').textContent = `å…¨${slideCount}æšã®ã‚¹ãƒ©ã‚¤ãƒ‰`;
    }

    function showError(message) {
      document.getElementById('loadingScreen').innerHTML = `
        <div style="color: #ff6b6b; font-size: 18px;">${message}</div>
        <p style="color: #888; margin-top: 16px;">URLã«ã‚¹ãƒ©ã‚¤ãƒ‰IDã‚’æŒ‡å®šã—ã¦ãã ã•ã„</p>
      `;
    }

    async function startPresentation() {
      document.getElementById('startScreen').classList.add('hidden');

      // æœ€åˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ã®éŸ³å£°ã‚’äº‹å‰ç”Ÿæˆï¼ˆUXå‘ä¸Šï¼‰
      const firstSlide = slideData.slides[0];
      if (firstSlide?.speakerNotes) {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        document.getElementById('speakingIndicator').textContent = 'ğŸ”„ éŸ³å£°ã‚’æº–å‚™ä¸­...';
        document.getElementById('speakingIndicator').classList.add('active');

        await prefetchAudio(0);

        document.getElementById('speakingIndicator').classList.remove('active');
        document.getElementById('speakingIndicator').innerHTML = `
          <div class="wave"><span></span><span></span><span></span><span></span></div>
          èª­ã¿ä¸Šã’ä¸­...
        `;
      }

      renderCurrentSlide();
      updateUI();
    }

    // ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æ­£è¦åŒ–ï¼ˆãƒ•ãƒ©ãƒƒãƒˆæ§‹é€  â†’ ãƒã‚¹ãƒˆæ§‹é€ ï¼‰
    function normalizeSlideData(slide) {
      // ã™ã§ã« data ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹å ´åˆã¯ãã®ã¾ã¾è¿”ã™
      if (slide.data) return slide;

      // ãƒ•ãƒ©ãƒƒãƒˆæ§‹é€ ã‹ã‚‰ãƒã‚¹ãƒˆæ§‹é€ ã«å¤‰æ›
      const normalized = {
        type: slide.type,
        id: slide.id,
        speakerNotes: slide.speakerNotes,
        data: {}
      };

      // ã‚¿ã‚¤ãƒ—ã”ã¨ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’dataã«ã‚³ãƒ”ãƒ¼
      const commonProps = ['type', 'id', 'speakerNotes'];
      for (const key in slide) {
        if (!commonProps.includes(key)) {
          normalized.data[key] = slide[key];
        }
      }

      return normalized;
    }

    // ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderCurrentSlide() {
      if (!slideData || !slideData.slides) return;

      const rawSlide = slideData.slides[currentSlide];
      const slide = normalizeSlideData(rawSlide);
      const theme = slideData.settings?.theme || 'panhouse';

      document.body.setAttribute('data-theme', theme);

      const element = window.SlideRenderer.render(slide, theme);

      // SlideRenderer.render() ã¯HTMLElementã‚’è¿”ã™ã®ã§ã€appendChildã‚’ä½¿ç”¨
      const wrapper = document.getElementById('slideWrapper');
      wrapper.innerHTML = ''; // æ—¢å­˜ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢
      wrapper.appendChild(element);

      // ãƒãƒ¼ãƒˆæ›´æ–°
      const notes = slide.speakerNotes || '(ãƒãƒ¼ãƒˆãªã—)';
      document.getElementById('notesContent').textContent = notes;

      // ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´
      requestAnimationFrame(scaleSlide);
    }

    function scaleSlide() {
      const wrapper = document.getElementById('slideWrapper');
      const slideEl = wrapper?.querySelector('.slide');
      if (!slideEl) return;

      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight - 80; // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼åˆ†
      const slideWidth = 960;
      const slideHeight = 540;

      const scaleX = viewportWidth / slideWidth;
      const scaleY = viewportHeight / slideHeight;
      const scale = Math.min(scaleX, scaleY) * 0.9;

      slideEl.style.transform = `scale(${scale})`;
    }

    // UIæ›´æ–°
    function updateUI() {
      const total = slideData?.slides?.length || 1;
      document.getElementById('slideCounter').textContent = `${currentSlide + 1} / ${total}`;
      document.getElementById('progressFill').style.width = `${((currentSlide + 1) / total) * 100}%`;

      document.getElementById('prevBtn').disabled = currentSlide === 0;
      document.getElementById('nextBtn').disabled = currentSlide >= total - 1;

      document.getElementById('playPauseBtn').innerHTML = isPlaying ? 'â¸ ä¸€æ™‚åœæ­¢' : 'â–¶ å†ç”Ÿ';
    }

    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    function nextSlide() {
      if (currentSlide < slideData.slides.length - 1) {
        currentSlide++;
        renderCurrentSlide();
        updateUI();
        if (isPlaying) speakCurrentNotes();
      } else if (isPlaying) {
        stopPlayback();
      }
    }

    function prevSlide() {
      if (currentSlide > 0) {
        currentSlide--;
        renderCurrentSlide();
        updateUI();
        if (isPlaying) speakCurrentNotes();
      }
    }

    function seekSlide(event) {
      const bar = document.getElementById('progressBar');
      const rect = bar.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const percent = x / rect.width;
      currentSlide = Math.floor(percent * slideData.slides.length);
      currentSlide = Math.max(0, Math.min(currentSlide, slideData.slides.length - 1));
      renderCurrentSlide();
      updateUI();
    }

    // å†ç”Ÿåˆ¶å¾¡
    function togglePlayPause() {
      if (isPlaying) {
        stopPlayback();
      } else {
        startPlayback();
      }
    }

    function startPlayback() {
      isPlaying = true;
      updateUI();
      speakCurrentNotes();
    }

    function stopPlayback() {
      isPlaying = false;
      updateUI();
      stopSpeaking();
    }

    // éŸ³å£°ã‚’äº‹å‰ç”Ÿæˆã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
    async function prefetchAudio(slideIndex) {
      // ã™ã§ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—
      if (audioCache.has(slideIndex)) {
        console.log(`[TTS] ã‚¹ãƒ©ã‚¤ãƒ‰${slideIndex + 1}ã®éŸ³å£°ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿`);
        return audioCache.get(slideIndex);
      }

      const slide = slideData.slides[slideIndex];
      const notes = slide?.speakerNotes;

      if (!notes) {
        console.log(`[TTS] ã‚¹ãƒ©ã‚¤ãƒ‰${slideIndex + 1}ã«ãƒãƒ¼ãƒˆãªã—`);
        return null;
      }

      try {
        console.log(`[TTS] ã‚¹ãƒ©ã‚¤ãƒ‰${slideIndex + 1}ã®éŸ³å£°ã‚’ç”Ÿæˆä¸­...`);

        const response = await fetch(TTS_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            text: notes,
            voice: ttsSettings.voice,
            speed: ttsSettings.speed
          })
        });

        if (!response.ok) {
          console.error(`[TTS] API error for slide ${slideIndex + 1}:`, response.status);
          return null;
        }

        const blob = await response.blob();
        const audioUrl = URL.createObjectURL(blob);
        const cached = { audioUrl, blob };

        audioCache.set(slideIndex, cached);
        console.log(`[TTS] ã‚¹ãƒ©ã‚¤ãƒ‰${slideIndex + 1}ã®éŸ³å£°ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Œäº†`);

        return cached;
      } catch (error) {
        console.error(`[TTS] Error fetching audio for slide ${slideIndex + 1}:`, error);
        return null;
      }
    }

    // æ¬¡ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã®éŸ³å£°ã‚’è£ã§å…ˆèª­ã¿
    function prefetchNextSlide() {
      const nextIndex = currentSlide + 1;
      if (nextIndex < slideData.slides.length) {
        // éåŒæœŸã§å…ˆèª­ã¿ï¼ˆå¾…ãŸãªã„ï¼‰
        prefetchAudio(nextIndex);
      }
    }

    // TTSæ©Ÿèƒ½ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾å¿œç‰ˆï¼‰
    async function speakCurrentNotes() {
      const slide = slideData.slides[currentSlide];
      const notes = slide.speakerNotes;

      if (!notes) {
        // ãƒãƒ¼ãƒˆãŒãªã„å ´åˆã¯3ç§’å¾Œã«æ¬¡ã¸
        setTimeout(() => {
          if (isPlaying) nextSlide();
        }, 3000);
        // ãƒãƒ¼ãƒˆãŒãªãã¦ã‚‚æ¬¡ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã¯å…ˆèª­ã¿
        prefetchNextSlide();
        return;
      }

      stopSpeaking();

      try {
        // èª­ã¿ä¸Šã’ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
        document.getElementById('speakingIndicator').classList.add('active');
        isAudioPlaying = true;

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã€ãªã‘ã‚Œã°ç”Ÿæˆã‚’å¾…ã¤
        let cached = audioCache.get(currentSlide);
        if (!cached) {
          console.log(`[TTS] ã‚¹ãƒ©ã‚¤ãƒ‰${currentSlide + 1}ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ã€ç”Ÿæˆä¸­...`);
          cached = await prefetchAudio(currentSlide);
        }

        if (!cached) {
          // ç”Ÿæˆå¤±æ•—æ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—
          document.getElementById('speakingIndicator').classList.remove('active');
          if (isPlaying) {
            setTimeout(() => { if (isPlaying) nextSlide(); }, 3000);
          }
          return;
        }

        // æ¬¡ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å…ˆèª­ã¿é–‹å§‹
        prefetchNextSlide();

        // Audioè¦ç´ ã§å†ç”Ÿ
        audioElement = new Audio(cached.audioUrl);

        audioElement.onended = () => {
          document.getElementById('speakingIndicator').classList.remove('active');
          isAudioPlaying = false;
          if (isPlaying) {
            setTimeout(() => {
              if (isPlaying) nextSlide();
            }, 1000);
          }
        };

        audioElement.onerror = (e) => {
          console.error('Audio playback error:', e);
          document.getElementById('speakingIndicator').classList.remove('active');
          isAudioPlaying = false;
          if (isPlaying) {
            setTimeout(() => { if (isPlaying) nextSlide(); }, 3000);
          }
        };

        audioElement.play();

      } catch (error) {
        console.error('TTS error:', error);
        document.getElementById('speakingIndicator').classList.remove('active');
        isAudioPlaying = false;
        if (isPlaying) {
          setTimeout(() => { if (isPlaying) nextSlide(); }, 3000);
        }
      }
    }

    function stopSpeaking() {
      if (audioElement) {
        audioElement.pause();
        audioElement.currentTime = 0;
        audioElement = null;
      }
      isAudioPlaying = false;
      document.getElementById('speakingIndicator').classList.remove('active');
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ¡ãƒ¢ãƒªè§£æ”¾ç”¨ï¼‰
    function clearAudioCache() {
      for (const [index, cached] of audioCache) {
        if (cached.audioUrl) {
          URL.revokeObjectURL(cached.audioUrl);
        }
      }
      audioCache.clear();
      console.log('[TTS] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
    }

    // ãƒãƒ¼ãƒˆè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    function toggleNotes() {
      showNotes = !showNotes;
      document.getElementById('notesPanel').classList.toggle('visible', showNotes);
    }

    // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

      switch (e.key) {
        case 'ArrowRight':
        case ' ':
          nextSlide();
          break;
        case 'ArrowLeft':
          prevSlide();
          break;
        case 'f':
        case 'F':
          toggleFullscreen();
          break;
        case 'Escape':
          stopPlayback();
          break;
      }
    });

    // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
    window.addEventListener('resize', scaleSlide);

    // åˆæœŸåŒ–å®Ÿè¡Œ
    init();
  </script>
</body>
</html>
