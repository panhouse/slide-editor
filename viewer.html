<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Slide Viewer</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="css/slide.css?v=8">
  <link rel="stylesheet" href="css/themes/panhouse.css">
  <link rel="stylesheet" href="css/themes/consulting.css?v=9">

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      background: #1a1a2e;
      font-family: 'Noto Sans JP', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .viewer-container {
      width: 100%;
      max-width: 1200px;
      padding: 20px;
    }
    .slide-wrapper {
      background: transparent;
      border-radius: 8px;
      overflow: hidden;
      aspect-ratio: 16/9;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .slide {
      width: 100%;
      height: 100%;
      padding: 0;
      position: relative;
      background: white;
    }
    .nav-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 20px;
      color: white;
    }
    .nav-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
    }
    .nav-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .page-info {
      font-size: 16px;
      color: rgba(255,255,255,0.7);
    }
    .loading {
      color: white;
      font-size: 18px;
      text-align: center;
    }
    .error {
      color: #ff6b6b;
      font-size: 18px;
      text-align: center;
      padding: 40px;
    }
  </style>
</head>
<body>
  <div class="viewer-container">
    <div class="slide-wrapper">
      <div class="slide" id="slideCanvas">
        <div class="loading">読み込み中...</div>
      </div>
    </div>
    <div class="nav-controls">
      <button class="nav-btn" id="prevBtn" disabled>&larr; 前へ</button>
      <span class="page-info"><span id="currentPage">1</span> / <span id="totalPages">1</span></span>
      <button class="nav-btn" id="nextBtn" disabled>次へ &rarr;</button>
    </div>
  </div>

  <!-- Core Scripts (Renderer Only) -->
  <script src="js/core/Utils.js?v=3"></script>
  <script src="js/core/EventBus.js?v=3"></script>
  <script src="js/core/SlideManager.js?v=8"></script>
  <script src="js/core/JsonParser.js?v=8"></script>
  <script src="js/renderer/types/BaseRenderer.js?v=8"></script>
  <script src="js/renderer/types/TitleRenderer.js?v=5"></script>
  <script src="js/renderer/types/ContentRenderer.js?v=6"></script>
  <script src="js/renderer/types/TableRenderer.js?v=5"></script>
  <script src="js/renderer/types/CompareRenderer.js?v=4"></script>
  <script src="js/renderer/types/CardsRenderer.js?v=4"></script>
  <script src="js/renderer/types/TimelineRenderer.js?v=4"></script>
  <script src="js/renderer/types/ImageRenderer.js?v=4"></script>
  <script src="js/renderer/types/TextRenderer.js?v=4"></script>
  <script src="js/renderer/types/ProcessRenderer.js?v=1"></script>
  <script src="js/renderer/types/MatrixRenderer.js?v=1"></script>
  <script src="js/renderer/types/KpiRenderer.js?v=2"></script>
  <script src="js/renderer/types/RoadmapRenderer.js?v=1"></script>
  <script src="js/renderer/types/QuoteRenderer.js?v=1"></script>
  <script src="js/renderer/types/IconCardsRenderer.js?v=1"></script>
  <script src="js/renderer/SlideRenderer.js?v=12"></script>
  <script src="js/themes/ThemeManager.js?v=4"></script>

  <script>
    // Viewer Only Mode
    window.DEBUG = false;

    let currentSlideIndex = 0;
    let slides = [];

    const SUPABASE_URL = 'https://fwykesvqriophaagunki.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3eWtlc3ZxcmlvcGhhYWd1bmtpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MzcyNzgsImV4cCI6MjA4MDQxMzI3OH0.8gPGdAJ2b-hfqgtB_Cc_POWZ9vNs6X0lvST57-fDq9o';

    async function loadFromSupabase(slideId) {
      try {
        const apiUrl = `${SUPABASE_URL}/rest/v1/slides?id=eq.${slideId}&select=slide_json`;
        const response = await fetch(apiUrl, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          }
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const rows = await response.json();
        if (!rows || rows.length === 0) throw new Error('Slide not found');

        const slideJson = rows[0].slide_json;
        return typeof slideJson === 'string' ? JSON.parse(slideJson) : slideJson;
      } catch (error) {
        throw error;
      }
    }

    function renderSlide(index) {
      if (index < 0 || index >= slides.length) return;

      currentSlideIndex = index;
      const slideCanvas = document.getElementById('slideCanvas');
      const slideData = slides[index];

      // Apply theme
      slideCanvas.className = 'slide';
      const settings = SlideManager.getSettings();
      if (settings.theme) {
        slideCanvas.classList.add(`theme-${settings.theme}`);
      }

      // Render (SlideRenderer is already instantiated as window.SlideRenderer)
      slideCanvas.innerHTML = '';
      const content = SlideRenderer.render(slideData);
      slideCanvas.appendChild(content);

      // Update navigation
      document.getElementById('currentPage').textContent = index + 1;
      document.getElementById('prevBtn').disabled = index === 0;
      document.getElementById('nextBtn').disabled = index === slides.length - 1;
    }

    function showError(message) {
      document.getElementById('slideCanvas').innerHTML = `<div class="error">${message}</div>`;
    }

    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      const slideId = urlParams.get('id');

      if (!slideId) {
        showError('スライドIDが指定されていません。<br>?id=xxx の形式でアクセスしてください。');
        return;
      }

      try {
        const data = await loadFromSupabase(slideId);

        // Initialize SlideManager
        SlideManager.loadFromJson(data);
        slides = SlideManager.getSlides();

        // Apply theme
        if (data.settings?.theme) {
          ThemeManager.setTheme(data.settings.theme);
        }

        // Update total pages
        document.getElementById('totalPages').textContent = slides.length;

        // Render first slide
        renderSlide(0);

      } catch (error) {
        showError(`読み込みエラー: ${error.message}`);
      }
    }

    // Navigation
    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentSlideIndex > 0) renderSlide(currentSlideIndex - 1);
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (currentSlideIndex < slides.length - 1) renderSlide(currentSlideIndex + 1);
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        if (currentSlideIndex > 0) renderSlide(currentSlideIndex - 1);
      } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown' || e.key === ' ') {
        if (currentSlideIndex < slides.length - 1) renderSlide(currentSlideIndex + 1);
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
